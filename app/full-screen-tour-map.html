<div id="scoped-content">
  <style type="text/css" scoped>
    #map {
      width: 100%;
      height: 75vh;
    }
    #map .infowindow {
      overflow: hidden;
      font-family: 'Roboto', Helvetica, Arial, Lucida, sans-serif;
    }
    #map .infowindow .heading {
      margin-bottom: 6px;
    }
    #map .infowindow .heading #icon {
      position: relative;
      width: auto;
      height: 30px;
      top: 4px;
    }
    #map .infowindow .heading h1 {
      display: inline;
      margin-left: 12px;
      font-size: 24px;
    }
    #map .infowindow .main-infowindow-content {
      margin-top: 5px;
      display: flex;
      flex-wrap: wrap;
      font-size: 14px;
      font-weight: 500;
    }
    #map .infowindow .main-infowindow-content .left-panel {
      width: 180px;
    }
    #map .infowindow .main-infowindow-content .left-panel .date {
      font-size: 12px;
      font-weight: 400;
      margin: 5px 0 0 0;
    }
    #map .infowindow .main-infowindow-content .left-panel .description {
      margin: 3px 5px 0 0;
      padding-top: 7px;
      color: #111;
      font-weight: 500;
      word-wrap: break-word;
      border-top: 2px solid #517cb5;
    }
    #map .infowindow .main-infowindow-content .left-panel .links a {
      font-size: 13px;
      text-decoration: none;
      color: #00f;
      line-height: 1.5em;
    }
    #map .infowindow .main-infowindow-content .left-panel .links a:hover {
      color: #51b568;
    }
    #map .infowindow .main-infowindow-content .left-panel .links a:before {
      content: "> ";
    }
    #map .infowindow .main-infowindow-content .left-panel .rideData a {
      text-decoration: none;
      color: #f00;
    }
    #map .infowindow .main-infowindow-content .left-panel .links {
      border-top: 2px solid #298771;
    }
    #map .infowindow .main-infowindow-content .left-panel .rideData {
      border-top: 2px solid #298771;
    }
    #map .infowindow .main-infowindow-content .left-panel .rideData,
    #map .infowindow .main-infowindow-content .left-panel .links {
      margin: 10px 5px 0 0;
      padding: 4px 0;
    }
    #map .infowindow .main-infowindow-content .left-panel .rideData p,
    #map .infowindow .main-infowindow-content .left-panel .links p {
      font-weight: 500;
      font-size: 14px;
    }
    #map .infowindow .main-infowindow-content img {
      max-width: 300px;
      max-height: 200px;
      margin: 7px 0 7px 5px;
    }
    #map .infowindow .main-infowindow-content iframe {
      margin: 10px 0 5px 5px;
    }
    .below-map {
      width: 100%;
      height: 140px;
      font-size: 17px;
      font-family: 'Roboto', Helvetica, Arial, Lucida, sans-serif;
      display: flex;
    }
    .below-map .map-options {
      height: 100%;
      line-height: 100px;
      text-align: center;
      width: 18vw;
      min-width: 75px;
    }
    .below-map .map-options #show-route {
      margin-top: 17px;
      margin: 10px 3px;
      padding: 10px;
      border: 3px solid black;
      border-radius: 2px;
      background-color: #fff;
      font-weight: bold;
    }
    .below-map .map-legend {
      display: inline-block;
      height: 100%;
      width: 82vw;
      padding: 5px 0;
    }
    .below-map .map-legend img {
      padding-top: 10px;
      max-height: 100%;
      max-width: 100%;
    }
  </style>
  <div id="map"></div>
  <div class="below-map">
    <div class="map-options">
      <button id="show-route">Show Ridden Route</button>
    </div>
    <div class="map-legend">
      <img src="http://travelingtice.com/wp-content/uploads/google-maps/images/legend.png" alt="map legend">
    </div>
  </div>
</div>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0C0AacrdTQ6ihc98emn8zDCwah2o6dIE&callback=initMap"></script>
<script>
  /* global google */
  // The lines object contains all the trips (lines) and those contain all the markers.
  const lines = {
    none: [],
    ImHere: [],
    // Add your lines here: LINENAME: [];
    EUp1: [],
    EUp2: [],
    EUp2P: []
  };
  const lineIntervals = {
    none: 0,
    ImHere: 0,
    // Add intervals here
    EUp1: 30,
    EUp2: 30,
    EUp2P: 0
  }
  // Here you can style your lines if you need to
  const lineStyles = {
    EUp1: {
      name: 'EUp1',
      strokeWeight: 1.5
    },
    EUp2: {
      name: 'EUp2',
      strokeWeight: 1.5
    },
    EUp2P: {
      name: 'EUp2P',
      strokeWeight: 1,
      strokeOpacity: 0.5
    }
  }
  // Add optional KML Lines
  const kmlLines = {
    EUp1: {
      url: 'http://travelingtice.com/wp-content/uploads/google-maps/kml/EUp1.kml'
    }
  }
  const iconPath = 'http://travelingtice.com/wp-content/uploads/google-maps/icons/';
  const imgPath = 'http://travelingtice.com/wp-content/uploads/google-maps/images/';
  const jsonPath = 'http://travelingtice.com/wp-content/uploads/google-maps/';
  let map; // Global variables map
  // Status of the map
  let mapLoaded = false;
  // Status of KML layer on the map
  let isKmlOnMap = false;
  // All of our polylines
  let polylines = [];
  // All of our KML layers
  let kmlLayers = [];
  // Map gets initialized
  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: {
        lat: 53.661212,
        lng: 10.898780
      },
      zoom: 4
    });
    getMarkers();
    getKmlLines();
    addBtnListener();
  }
  // Get markers from database
  function getMarkers() {
    let locations = [];
    // Get info of all locations
    fetch(`${jsonPath}locations.json`).then(resp => resp.json()).then(resp => {
      locations = resp;
      makeMarkers(locations);
    });
  }
  // Instantiate marker objects from the markers we passed in
  function makeMarkers(locations) {
    // Create 1 infowindow so 1 gets shared by all the markers
    const infoWindow = new google.maps.InfoWindow();
    locations.forEach((location, i) => {
      // Check if location has these optional props
      const links = location.links ? location.links : null;
      const youtube = location.youtube ? location.youtube : null;
      const img = location.img ? imgPath + location.img : null;
      const rideData = location.rideData ? location.rideData : null;
      const icon = location.icon ? iconPath + location.icon : null;
      const line = location.line ? location.line : 'none';
      const zIndex = location.zIndex ? location.zIndex : 1;
      const animation = location.animation === false ? null : google.maps.Animation.DROP;
      // Create marker object
      const marker = new google.maps.Marker({
        map: null,
        animation,
        id: i,
        // Assign props all locations have
        position: location.location,
        title: location.title,
        date: location.date,
        description: location.description,
        // Optional props
        youtube,
        img,
        rideData,
        links,
        icon,
        zIndex,
        line
      });
      // Push all markers to appropriate array
      for (const lineName in lines) {
        if (marker.line === lineName) {
          lines[lineName].push(marker)
        }
      }
      // Create click event to open/close infowindow at each marker
      marker.addListener('click', function() {
        if (infoWindow.marker != marker) {
          populateInfoWindow(this, infoWindow);
          map.addListener('click', function() {
            infoWindow.close();
            infoWindow.marker = null;
          })
        } else {
          infoWindow.close();
          infoWindow.marker = null;
        }
      });
    });
    google.maps.event.addListener(map, 'tilesloaded', function() {
      openMarkers();
    });
  }
  function openMarkers() {
    // Go through all marker arrays and filter them so right animation is applied.
    if (!mapLoaded) {
      let longestArray = [];
      let longestArrayName;
      let interval;
      let longestInterval;
      for (const line in lines) {
        const markerArray = lines[line];
        // Set longestArray to this array if it is the longest
        if (markerArray.length > longestArray.length) {
          longestArray = markerArray;
          longestArrayName = line;
        }
        // Choose interval for our arrays
        for (const thisLine in lineIntervals) {
          if (longestArrayName === thisLine) {
            longestInterval = lineIntervals[thisLine];
          }
          if (thisLine === line) {
            if (line !== 'ImHere') {
              interval = lineIntervals[line];
              openMarkerArray(markerArray, 0, interval, line)
            }
          }
        }
      }
      interval = longestArray.length * longestInterval + 1000;
      openImHereMarker(interval);
    }
  }
  // The 'I'm Here' marker will be spawned last
  function openImHereMarker(interval) {
    for (const line in lines) {
      if (line === 'ImHere') {
        const ImHereMarker = lines[line];
        openMarkerArray(ImHereMarker, 0, interval, line);
      }
    }
    mapLoaded = true;
  }
  // This sets each marker in the array to map.
  function openMarkerArray(array, i, interval, line) {
    setTimeout(() => {
      const marker = array[i];
      ++i;
      if (i <= array.length) {
        marker.setMap(map);
        // Last marker is ImHere, so after this, our map is loaded!
        if (line === 'ImHere') {
          mapLoaded = true;
        }
        openMarkerArray(array, i, interval, line);
      } else {
        switch (line) {
          case 'none':
            // Open no line
            break;
          case 'ImHere':
            // Open no line
            break;
          default:
            openLine(array, line);
        }
      }
    }, interval);
  }
  // This one draws the line to the map
  function openLine(array, line) {
    const points = [];
    array.forEach(marker => {
      points.push(marker.position);
    });
    let polylineOptions = {
      strokeWeight: 1.5,
      name: line
    };
    // Options for the polyline (derived from lineStyles)
    for (const styleLine in lineStyles) {
      if (styleLine === line) {
        polylineOptions = lineStyles[styleLine];
      }
    }
    // Create polyline
    const polyline = new google.maps.Polyline(polylineOptions);
    // Set path to path we created using the markers
    polyline.setPath(points);
    // Set polyline to our map
    polyline.setMap(map);
    // Push to polyline array
    polylines.push(polyline);
  }
  // This closes the line that is connected between marker of a certain line with name
  function closeALine(line) {
    polylines.forEach(polyline => {
      if (polyline.name === line) {
        polyline.setMap(null);
      }
    });
  }
  // Closes all polylines
  function closeAllLines() {
    polylines.forEach(polyline => {
      polyline.setMap(null);
    });
  }
  // Opens all polylines
  function openAllLines() {
    polylines.forEach(polyline => {
      polyline.setMap(map);
    });
  }
  // This one opens all our markers, if they have been closed before
  function openAllMarkers() {
    for (const lineName in lines) {
      const markerArray = lines[lineName];
      markerArray.forEach(marker => {
        marker.setMap(map);
      });
    }
  }
  // This one closes all our markers, that are not ImHere
  function closeAllMarkers() {
    for (const lineName in lines) {
      const markerArray = lines[lineName];
      markerArray.forEach(marker => {
        marker.setMap(null);
      });
    }
  }
  // Gets all KML files from url in kmlLines object and does not display them
  function getKmlLines() {
    for (const line in kmlLines) {
      const url = kmlLines[line].url;
      const kml = new google.maps.KmlLayer({
        url,
        map: null,
        preserveViewport: true,
        suppressInfoWindows: true
      });
      kmlLayers.push(kml);
    }
  }
  // Open KML layers
  function openKmlLines() {
    kmlLayers.forEach(layer => {
      layer.setMap(map);
    });
  }
  // Close KML layers
  function closeKmlLines() {
    kmlLayers.forEach(layer => {
      layer.setMap(null);
    });
  }
  // Open infowindow at marker
  function populateInfoWindow(marker, infowindow) {
    // Check to make sure infowindow is not open already on this marker
    const html = generateHtmlInfowindow(marker);
    infowindow.marker = marker;
    infowindow.setContent(html);
    infowindow.open(map, marker);
    // make sure marker is properly cleared if infowindow is closed
    infowindow.addListener('closeclick', () => infowindow.marker = null);
    // also add event listener to our map, so you can click on the map to close the infowindow as well.
  }
  // Return html that is content of our infowindow
  function generateHtmlInfowindow(marker) {
    let html = `<div class="infowindow"><div class="heading"><img id="icon" src="${marker.icon}" alt="marker"><h1>${marker.title}</h1></div><div class="main-infowindow-content">`;
    // Check if marker has description, img, yt etc.. And generate html accordingly
    // has description
    if (marker.description) {
      html += '<div class="left-panel">';
      // has date
      if (marker.date) {
        html += `<p class="date">${marker.date}</p>`;
      }
      html += `<p class="description">${marker.description}</p>`;
    } else if (marker.date) {
      // has no description but has date
      html += `<div class="left-panel"><p class="date">${marker.date}</p>`;
    } else {
      // has no description and no date
      html += '<div class="left-panel">';
    }
    // has links
    if (marker.links) {
      html += `<div class="links"><p>${marker.links.title}</p>`;
      marker.links.links.forEach(link => {
        html += `<a href="${link.link}" target="_blank">${link.name}</a><br>`;
      });
      html += '</div>';
    }
    if (marker.rideData) {
      html += `<div class="rideData"><a href="${marker.rideData}" target="_blank">View ride data</a></div>`
    }
    html += '</div>'
    if (marker.img) {
      html += `<img src="${marker.img}" alt="${marker.title}">`;
    }
    if (marker.youtube) {
      html += `<iframe width="391" height="220" src="https://www.youtube.com/embed/${marker.youtube}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
    }
    html += '</div>';
    return html;
  }
  function addBtnListener() {
    const btn1 = document.getElementById('show-route');
      btn1.addEventListener('click', () => {
        if (mapLoaded) {
          if (!isKmlOnMap) {
            closeAllLines();
            closeAllMarkers();
            openKmlLines();
            btn1.innerHTML = 'Hide Ridden Route';
          } else {
            closeKmlLines();
            openAllMarkers();
            openAllLines();
            btn1.innerHTML = 'Show Ridden Route';
          }
          isKmlOnMap = !isKmlOnMap;
        }
    });
  }
</script>
